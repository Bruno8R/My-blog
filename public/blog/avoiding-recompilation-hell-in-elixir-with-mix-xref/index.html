<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Recompilation hell: what it feels like\rElixir is an amazing language and it&rsquo;s been a huge privilege being able to work with it for over a decade now (how time flies)!\nI&rsquo;d like to point out an issue that, if overlooked, can severely impact productivity in your team. Yes, I&rsquo;m talking about module (re)compilation.\nYou make a few changes to a single file in your codebase and hit recompile. Boom: Compiling 93 files (.ex). Then you make another change and boom: Compiling 103 files (.ex).\n">
<title>Avoiding recompilation hell in Elixir with mix xref</title>

<link rel='canonical' href='http://localhost:1313/blog/avoiding-recompilation-hell-in-elixir-with-mix-xref/'>

<link rel="stylesheet" href="/scss/style.min.b9c8156d464c343bdacaf14a871581fb94cbbdb9dd5cbce4ba017361187cc930.css"><meta property='og:title' content="Avoiding recompilation hell in Elixir with mix xref">
<meta property='og:description' content="Recompilation hell: what it feels like\rElixir is an amazing language and it&rsquo;s been a huge privilege being able to work with it for over a decade now (how time flies)!\nI&rsquo;d like to point out an issue that, if overlooked, can severely impact productivity in your team. Yes, I&rsquo;m talking about module (re)compilation.\nYou make a few changes to a single file in your codebase and hit recompile. Boom: Compiling 93 files (.ex). Then you make another change and boom: Compiling 103 files (.ex).\n">
<meta property='og:url' content='http://localhost:1313/blog/avoiding-recompilation-hell-in-elixir-with-mix-xref/'>
<meta property='og:site_name' content='Bruno de Barros Ricardo'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Elixir' /><meta property='article:published_time' content='2024-10-22T19:04:35-03:00'/><meta property='article:modified_time' content='2024-10-22T19:04:35-03:00'/><meta property='og:image' content='http://localhost:1313/blog/avoiding-recompilation-hell-in-elixir-with-mix-xref/cover.webp' />
<meta name="twitter:title" content="Avoiding recompilation hell in Elixir with mix xref">
<meta name="twitter:description" content="Recompilation hell: what it feels like\rElixir is an amazing language and it&rsquo;s been a huge privilege being able to work with it for over a decade now (how time flies)!\nI&rsquo;d like to point out an issue that, if overlooked, can severely impact productivity in your team. Yes, I&rsquo;m talking about module (re)compilation.\nYou make a few changes to a single file in your codebase and hit recompile. Boom: Compiling 93 files (.ex). Then you make another change and boom: Compiling 103 files (.ex).\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://localhost:1313/blog/avoiding-recompilation-hell-in-elixir-with-mix-xref/cover.webp' />
    <link rel="shortcut icon" href="/favicon.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu13739649187745961479.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Bruno de Barros Ricardo</a></h1>
            <h2 class="site-description">Things I learned during my runtime.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/RenatoMassaro'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='mailto:r@ena.to'
                        target="_blank"
                        title="Email"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mail" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z" />
  <path d="M3 7l9 6l9 -6" />
</svg>

                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/blog/about_me/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About Me</span>
            </a>
        </li>
        
        
        <li >
            <a href='/blog/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/blog/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/blog/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="http://localhost:1313/" selected>English</option>
                                
                                    <option value="http://localhost:1313/pt-br/" >Português</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#recompilation-hell-what-it-feels-like">Recompilation hell: what it feels like</a></li>
    <li><a href="#why-it-matters">Why it matters</a></li>
    <li><a href="#step-1-detecting-the-issue"><strong>Step 1: Detecting the issue</strong></a>
      <ol>
        <li><a href="#a-primer-on-mix-xref">A primer on <code>mix xref</code></a></li>
      </ol>
    </li>
    <li><a href="#step-2-understanding-the-issue"><strong>Step 2: Understanding the issue</strong></a>
      <ol>
        <li><a href="#module-recompilation-in-elixir">Module (re)compilation in Elixir</a>
          <ol>
            <li><a href="#scenario-1-runtime-dependencies">Scenario 1: runtime dependencies</a></li>
            <li><a href="#scenario-2-compile-time-dependencies">Scenario 2: compile-time dependencies</a></li>
            <li><a href="#scenario-3-transitive-compile-time-dependencies">Scenario 3: transitive compile-time dependencies</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#step-3-fixing-the-issue"><strong>Step 3: Fixing the issue</strong></a>
      <ol>
        <li><a href="#identifying-transitive-dependencies">Identifying transitive dependencies</a></li>
        <li><a href="#getting-rid-of-compile-time-dependencies">Getting rid of compile-time dependencies</a>
          <ol>
            <li><a href="#strategy-1-move-macros-to-dedicated-modules-with-no-additional-dependencies">Strategy 1: Move macros to dedicated modules with no additional dependencies</a></li>
            <li><a href="#strategy-2-reference-the-module-during-runtime-absinthe-example">Strategy 2: Reference the module during runtime (Absinthe example)</a></li>
            <li><a href="#strategy-3-keep-macros-simple">Strategy 3: Keep macros simple</a></li>
            <li><a href="#strategy-4-dont-use-macros">Strategy 4: Don&rsquo;t use macros</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#step-4-preventing-it-from-ever-happening-again"><strong>Step 4: Preventing it from ever happening again</strong></a>
      <ol>
        <li><a href="#detecting-transitive-dependencies-in-your-ci-pipeline">Detecting transitive dependencies in your CI pipeline</a></li>
      </ol>
    </li>
    <li><a href="#worth-mentioning">Worth mentioning</a>
      <ol>
        <li><a href="#pattern-matching-on-structs-no-longer-creates-compile-time-dependencies">Pattern-matching on structs no longer creates compile-time dependencies</a></li>
        <li><a href="#dont-blindly-rely-on-mix-xref-for-boundaries">Don&rsquo;t (blindly) rely on <code>mix xref</code> for boundaries</a></li>
        <li><a href="#visualizing-your-dependencies-with-depviz-and-graphviz">Visualizing your dependencies with <code>DepViz</code> and <code>Graphviz</code></a></li>
      </ol>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#notes">Notes</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/blog/avoiding-recompilation-hell-in-elixir-with-mix-xref/">
                <img src="/blog/avoiding-recompilation-hell-in-elixir-with-mix-xref/cover_hu13175049529617834328.webp"
                        srcset="/blog/avoiding-recompilation-hell-in-elixir-with-mix-xref/cover_hu13175049529617834328.webp 800w, /blog/avoiding-recompilation-hell-in-elixir-with-mix-xref/cover_hu8229562703011462843.webp 1600w"
                        width="800" 
                        height="800" 
                        loading="lazy"
                        alt="Featured image of post Avoiding recompilation hell in Elixir with mix xref" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/programming/" >
                Programming
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/blog/avoiding-recompilation-hell-in-elixir-with-mix-xref/">Avoiding recompilation hell in Elixir with mix xref</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Oct 22, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    17 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="recompilation-hell-what-it-feels-like">Recompilation hell: what it feels like
</h2><p>Elixir is an amazing language and it&rsquo;s been a huge privilege being able to work with it for over a decade now (how time flies)!</p>
<p>I&rsquo;d like to point out an issue that, if overlooked, can severely impact productivity in your team. Yes, I&rsquo;m talking about module (re)compilation.</p>
<p>You make a few changes to <em>a single file</em> in your codebase and hit recompile. Boom: <code>Compiling 93 files (.ex)</code>. Then you make another change and boom: <code>Compiling 103 files (.ex)</code>.</p>
<p>We&rsquo;ve all been there. There <em>is</em> a solution to this problem. Whether the solution is painful depends on how long this problem has gone unaddressed in your codebase.</p>
<p>If you don&rsquo;t actively fix this, the number of recompiled files will likely grow as your project grows, and the harder it will be to get rid of it.</p>
<h2 id="why-it-matters">Why it matters
</h2><p>Before sharing how to detect, fix and prevent it from ever happening again, I&rsquo;d like to briefly go over why it matters and why you should <em>absolutely</em> care about this.</p>
<p>The feedback time, that is, the time it takes for a developer to iterate between <em>making changes</em> and <em>observing the changes</em> is the single, most important individual productivity metric you should monitor.</p>
<p>Tighten your feedback loop: if you change one module, ideally only one module should recompile. If you are doing localhost web development, your localhost page should have near-instant page loads. There are exceptions to this, but if you are the exception you are <em>conscious</em> that you are the exception.</p>
<h2 id="step-1-detecting-the-issue"><strong>Step 1: Detecting the issue</strong>
</h2><p>Well, <em>detecting</em> is easy: you change one module and several ones get recompiled? Yep, you are in recompilation hell. But how can you know in which <em>circle</em> of hell are you in?</p>
<p>You can use the most underestimated tool in the Elixir ecosystem!</p>
<h3 id="a-primer-on-mix-xref">A primer on <code>mix xref</code>
</h3><p><a class="link" href="https://hexdocs.pm/mix/1.17.3/Mix.Tasks.Xref.html"  target="_blank" rel="noopener"
    ><code>mix xref</code></a> is, without a doubt, the most underestimated tool<a class="link" href="#notes" >[0]</a> in the Elixir ecosystem. Think of it as being a swiss army knife that provides insights in the relationships between modules in your codebase.</p>
<p>It can help you:</p>
<details>
  <summary>List all compile-time dependencies in a project</summary>
  mix xref graph --label compile
</details>
<details>
  <summary>List all files that depend on foo.ex at compile time</summary>
  mix xref graph --label compile --sink lib/foo.ex --only-nodes
</details>
<details>
  <summary>List all callers of a given module</summary>
  mix xref callers Core.Schemas.Admin
</details>
<details>
  <summary>List every dependency that is linked to a particular file</summary>
  mix xref trace lib/foo.ex
</details>
<details>
  <summary>Generate a graph with all compile-time dependencies</summary>
  mix xref graph --format dot --label compile<br/>
  dot -Tsvg xref_graph.dot -o xref_graph.svg
</details>
<h2 id="step-2-understanding-the-issue"><strong>Step 2: Understanding the issue</strong>
</h2><p>Okay, you know you are in recompilation hell. But do you know <em>why</em> you are in hell? My guess is: you&rsquo;ve sinned with macros.</p>
<p>In order to fully comprehend the issue, you will need first to understand the interaction between modules and what creates a compilation dependency.</p>
<h3 id="module-recompilation-in-elixir">Module (re)compilation in Elixir
</h3><p>Let&rsquo;s understand, once and for all, how modules recompile in Elixir.</p>
<h4 id="scenario-1-runtime-dependencies">Scenario 1: runtime dependencies
</h4><p>In this first scenario, there are only runtime function calls: A1 calls B1 which calls C1.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="c1"># lib/a1.ex</span>
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">A1</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">call_b</span><span class="p">,</span> <span class="ss">do</span><span class="p">:</span> <span class="nc">B1</span><span class="o">.</span><span class="n">call_c</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># lib/b1.ex</span>
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">B1</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">call_c</span><span class="p">,</span> <span class="ss">do</span><span class="p">:</span> <span class="nc">C1</span><span class="o">.</span><span class="n">do_something</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># lib/c1.ex</span>
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">C1</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">do_something</span><span class="p">,</span> <span class="ss">do</span><span class="p">:</span> <span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s2">&#34;I did something!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here&rsquo;s the output of <code>mix xref graph</code>: <a class="link" href="#notes" >[1]</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">lib/a1.ex
</span></span><span class="line"><span class="cl">└── lib/b1.ex
</span></span><span class="line"><span class="cl">lib/b1.ex
</span></span><span class="line"><span class="cl">└── lib/c1.ex
</span></span><span class="line"><span class="cl">lib/c1.ex
</span></span></code></pre></td></tr></table>
</div>
</div><p>It tells us that <code>lib/a1.ex</code> has a runtime dependency to <code>lib/b1.ex</code>, which in turn has a runtime dependency to <code>lib/c1.ex</code>, which has no dependencies.</p>
<blockquote>
<p>NOTE: We can tell this is a runtime dependency because the <code>mix xref</code> output has no additional information next to the file path. If they were compile-time dependencies, we&rsquo;d see &ldquo;lib/a1.ex (compile)&rdquo; instead.</p>
</blockquote>
<p>Recompilation output when changing any of these modules individually:</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>lib/a1.ex</th>
          <th>lib/b1.ex</th>
          <th>lib/c1.ex</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Compiling 1 file</td>
          <td>Compiling 1 file</td>
          <td>Compiling 1 file</td>
      </tr>
  </tbody>
</table></div>
<p>Runtime dependencies are great because it means that changing <em>one</em> module will require recompilation of only that <em>one</em> module. In an ideal world, every module in your codebase would only depend on other modules at runtime.</p>
<h4 id="scenario-2-compile-time-dependencies">Scenario 2: compile-time dependencies
</h4><p>Alas, we don&rsquo;t live in an ideal world. Let&rsquo;s simulate a compile-time dependency</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="c1"># lib/a2.ex</span>
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">A2</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="na">@b</span> <span class="nc">B2</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">call_b</span><span class="p">,</span> <span class="ss">do</span><span class="p">:</span> <span class="na">@b</span><span class="o">.</span><span class="n">say_hello</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># lib/b2.ex</span>
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">B2</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="na">@person</span> <span class="nc">C2</span><span class="o">.</span><span class="n">get_person</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">say_hello</span><span class="p">,</span> <span class="ss">do</span><span class="p">:</span> <span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s2">&#34;Hello </span><span class="si">#{</span><span class="na">@person</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># lib/c2.ex</span>
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">C2</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">get_person</span><span class="p">,</span> <span class="ss">do</span><span class="p">:</span> <span class="ss">:mike</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you probably know, module attributes are evaluated at compile-time (this is actually why you should use <code>Application.compile_env/3</code> in module attributes). What that means for the code above is that:</p>
<ul>
<li>The <code>@b</code> attr in <code>A2</code> holds an <code>:Elixir.B2</code> atom that references the <code>B2</code> module</li>
<li>The <code>@person</code> attr in <code>B2</code> holds the <code>:mike</code> atom, which came from the call to <code>C2.get_person/0</code></li>
</ul>
<p>Elixir quiz time: which modules above will have a compilation-time dependency?</p>
<details>
  <summary>Click to see output of <code>mix xref graph</code></summary>
  <code>
  lib/a2.ex<br/>
  └── lib/b2.ex</br>
  lib/b2.ex</br>
  └── lib/c2.ex (compile)</br>
  lib/c2.ex
  </code>
</details>
<p>As one would expected, <code>B2</code> depends on <code>C2</code> during compile-time, since if we modify the result of <code>C2.person/0</code> to be,
ahem, <code>:joe</code>, <code>B2</code> will need to be re-compiled so that the <code>@person</code> module attribute can be re-evaluated.</p>
<p>Somewhat surprisingly, <code>A2</code> does <em>not</em> have a compile-time dependency on <code>B2</code>. The compiler is smart enough to track that <em>any</em> changes in the <code>B2</code> module would never cause the <code>@b</code> value to change.</p>
<p>Recompilation output when changing any of these modules individually:</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>lib/a2.ex</th>
          <th>lib/b2.ex</th>
          <th>lib/c2.ex</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Compiling 1 file</td>
          <td>Compiling 1 file</td>
          <td>Compiling 2 files</td>
      </tr>
  </tbody>
</table></div>
<p>Should we worry about these compile-time dependencies? Personally, I wouldn&rsquo;t worry too much until they become a noticeable issue. They may become noticeable when you start, for example, calling a particular function from a module attribute across several modules.</p>
<p>The reason I wouldn&rsquo;t bother <em>initially</em> is that this kind of compile-time dependency is usually easy to resolve. So go ahead, let your codebase evolve and grow, and if you get any sharp edges you can fix them later on.</p>
<p>Of course, that doesn&rsquo;t mean you can be negligent about this. When writing or reviewing code, always pay extra attention to module attributes. If you see a compilation dependency that has the potential to become nasty in the future — or that can be easily removed right away — go ahead and save yourself from future headaches.</p>
<h4 id="scenario-3-transitive-compile-time-dependencies">Scenario 3: transitive compile-time dependencies
</h4><p>The third scenario I&rsquo;d like to showcase is when your code has <em>transitive</em> compile-time dependencies. If you are suffering from recompilation pain, you are likely hitting this scenario.</p>
<p>Below is the smallest demo I could think of:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">A3</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="na">@runtime_dependency_on_b</span> <span class="nc">B3</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">foo</span><span class="p">,</span> <span class="ss">do</span><span class="p">:</span> <span class="ss">:foo</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">B3</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="na">@runtime_dependency_on_c</span> <span class="nc">C3</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">C3</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">ClientOne</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="na">@compile_time_dependency_on_a</span> <span class="nc">A3</span><span class="o">.</span><span class="n">foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">ClientTwo</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="na">@compile_time_dependency_on_a</span> <span class="nc">A3</span><span class="o">.</span><span class="n">foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">ClientThree</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="na">@compile_time_dependency_on_a</span> <span class="nc">A3</span><span class="o">.</span><span class="n">foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You have three &ldquo;clients&rdquo;. Clients are simply users of <code>A3</code> (with a regular compile-time dependency). <code>A3</code> then has a runtime dependency on <code>B3</code>, which also has a runtime dependency on <code>C3</code>. That doesn&rsquo;t sound too bad, right? Most importantly, it seems to be a regular occurrence in any given codebase.</p>
<blockquote>
<p>Here, what I meant by &ldquo;client&rdquo; is that there may be several instances using <code>A3</code>. Think events or endpoints or jobs, each of which with a compile-time dependency to their &ldquo;core&rdquo; implementation.</p>
</blockquote>
<p>This is what the compilation graph for these modules looks like:</p>
<p><img src="/blog/avoiding-recompilation-hell-in-elixir-with-mix-xref/scenario_3_compilation_graph_2.png"
	width="1154"
	height="581"
	srcset="/blog/avoiding-recompilation-hell-in-elixir-with-mix-xref/scenario_3_compilation_graph_2_hu15769631715035440735.png 480w, /blog/avoiding-recompilation-hell-in-elixir-with-mix-xref/scenario_3_compilation_graph_2_hu1055073890693304519.png 1024w"
	loading="lazy"
	
		alt="Seems harmless"
	
	
		class="gallery-image" 
		data-flex-grow="198"
		data-flex-basis="476px"
	
></p>
<p>Looking at the graph above, we expect that changes to <code>lib/a3.ex</code> will cause all N clients of it to be recompiled. Indeed, that&rsquo;s exactly what happens. But what would you expect to be recompiled if you were to change <code>lib/c3.ex</code>?</p>
<p>Only <code>C3</code>, right? Yes, me too. But here&rsquo;s what happens when I change <code>C3</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Compiling 4 files (.ex)
</span></span><span class="line"><span class="cl">Compiled lib/c3.ex
</span></span><span class="line"><span class="cl">Compiled lib/client_three.ex
</span></span><span class="line"><span class="cl">Compiled lib/client_two.ex
</span></span><span class="line"><span class="cl">Compiled lib/client_one.ex
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ouch, not good. What we are witnessing here is <em>transitive</em> compile-time dependencies in action.</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>lib/client_one.ex</th>
          <th>lib/a3.ex</th>
          <th>lib/b3.ex</th>
          <th>lib/c3.ex</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Compiling 1 file</td>
          <td>Compiling 4 files</td>
          <td>Compiling 4 files</td>
          <td>Compiling 4 files</td>
      </tr>
  </tbody>
</table></div>
<p>While my minimal example seems out of touch from reality, usually you will hit this scenario when:</p>
<ol>
<li>You have a <code>Core.Event</code> implementation with a macro</li>
<li>You have multiple <code>Event.MyEventName</code> modules that use macros from <code>Core.Event</code></li>
<li>You call <code>Services.Log</code> from within the macro</li>
<li>You call <code>Services.User</code> from within <code>Services.Log</code></li>
<li>You call <code>Schemas.User</code> from within <code>Services.User</code></li>
</ol>
<p>Every time you change your user schema, you are also recompiling every single one of your events.</p>
<p>Now imagine you follow a similar pattern with endpoints, job definitions, schemas, authorization, error handling, data validation, analytics. You can easily find yourself in a scenario where everything is tangled in a web of modules. One change basically recompiles every single module in your codebase.</p>
<blockquote>
<p>This is the worst! This is the eight circle of hell! It has the potential to bring your productivity down by multiple orders of magnitude! Do yourself (and your team) a favor and get rid of them — or monitor them <em>closely</em> so they don&rsquo;t grow inadvertently.</p>
</blockquote>
<p>In practice, the worst offenders of this are macros. You might be affected even if you don&rsquo;t write macros yourself: &ldquo;macro-heavy&rdquo; libraries, in particular, are prone to transitive dependencies (Absinthe is worth mentioning by name: <em>every</em> codebase I&rsquo;ve seen using Absinthe suffers from this).</p>
<h2 id="step-3-fixing-the-issue"><strong>Step 3: Fixing the issue</strong>
</h2><p>At this point, you know you are in hell, and more importantly you know why you are in hell. How can you get out, then? It basically boils down to two simple steps:</p>
<ol>
<li>Identifying the offending modules in key or common areas of your codebase; and</li>
<li>Refactoring them to not create compile-time dependencies.</li>
</ol>
<p>Will this be difficult? It depends on how &ldquo;spaghettified&rdquo; your modules are. If you have a big ball of mud, untangling your dependencies is likely to be painful.</p>
<blockquote>
<p>No matter how difficult this task turns out to be, however, I can guarantee you it&rsquo;s definitely worth the effort. And once untangled, if you keep reading this blog post until the end, you will learn what you have to do to prevent transitive dependencies from ever happening again.</p>
</blockquote>
<h3 id="identifying-transitive-dependencies">Identifying transitive dependencies
</h3><p>Let&rsquo;s go! First, you will need to identify what are the affected modules.</p>
<p>The easiest thing you can do is:</p>
<ol>
<li>Modify a module that triggers several other modules to recompile.</li>
<li>Run <code>mix compile --verbose</code>.</li>
</ol>
<p>Now you have a list of every module that was recompiled.</p>
<p>But we can do better than that! We can get the full &ldquo;path&rdquo; between two files using <code>mix xref</code>. This will make it substantially easier for you to understand exactly where the tangling is happening:</p>
<p><code>mix xref graph --source SOURCE --sink TARGET</code></p>
<blockquote>
<p>Here, <code>TARGET</code> is the file you changed and triggered recompilation of several unrelated files, and <code>SOURCE</code> is the module you think (or know) is starting the compilation chain. If you don&rsquo;t know which module is the <code>SOURCE</code>, simply use the last file shown in the <code>mix compile --verbose</code> command you ran above. It is likely the <code>SOURCE</code> you want.</p>
</blockquote>
<p>Below is the output for <a class="link" href="#scenario-3-transitive-compile-time-dependencies" >Scenario 3</a> discussed previously:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">lib/client_one.ex
</span></span><span class="line"><span class="cl">└── lib/a3.ex (compile)
</span></span><span class="line"><span class="cl">    └── lib/b3.ex
</span></span><span class="line"><span class="cl">        └── lib/c3.ex
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the example above, if you can either remove the compilation dependency between <code>client_one.ex</code> and <code>a3.ex</code> or remove the runtime dependency between <code>a3</code> and <code>b3</code>, you will break the compilation chain.</p>
<h3 id="getting-rid-of-compile-time-dependencies">Getting rid of compile-time dependencies
</h3><p>You have identified the compilation chain and now you need to break it. Below you will find a few strategies that you can use to refactor the offending modules.</p>
<h4 id="strategy-1-move-macros-to-dedicated-modules-with-no-additional-dependencies">Strategy 1: Move macros to dedicated modules with no additional dependencies
</h4><p>Initially, we have a <code>Core.Event</code> module that has both the macros and the generic functions that may be used by events.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="c1"># lib/strategy_1/before/event_user_created.ex</span>
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">S1.Before.Event.UserCreated</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="kn">use</span> <span class="nc">S1.Before.Core.Event</span>
</span></span><span class="line"><span class="cl">  <span class="na">@name</span> <span class="ss">:user_created_event</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">new</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="p">%{</span><span class="ss">user_id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># lib/strategy_1/before/core_event.ex</span>
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">S1.Before.Core.Event</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="kd">defmacro</span> <span class="n">__using__</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="k">quote</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">      <span class="kn">alias</span> <span class="n">__MODULE__</span>
</span></span><span class="line"><span class="cl">      <span class="na">@before_compile</span> <span class="k">unquote</span><span class="p">(</span><span class="n">__MODULE__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">defmacro</span> <span class="n">__before_compile__</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="k">quote</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">      <span class="na">@name</span> <span class="o">||</span> <span class="k">raise</span> <span class="s2">&#34;You must specify the event name via @name&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">def</span> <span class="n">get_name</span><span class="p">,</span> <span class="ss">do</span><span class="p">:</span> <span class="na">@name</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">emit</span><span class="p">(%{</span><span class="ss">id</span><span class="p">:</span> <span class="n">id</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="n">_data</span><span class="p">}),</span>
</span></span><span class="line"><span class="cl">    <span class="ss">do</span><span class="p">:</span> <span class="nc">S1.After.Services.Log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Emitting event_id=</span><span class="si">#{</span><span class="n">id</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># lib/strategy_1/before/service_log.ex</span>
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">S1.Before.Services.Log</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">info</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s2">&#34;[info] </span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice how <code>Services.Log</code> ends up as part of the compilation chain simply because it is part of the <code>Core.Event</code> module, even though it plays no special role in the macro itself. The command below tells us that there exists a transitive dependency (<code>mix ref</code> refers to them as &ldquo;compile-connected&rdquo;) between <code>event_user_created.ex</code> and <code>core_event.ex</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&gt; mix xref graph --label compile-connected | grep before
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">lib/strategy_1/before/event_user_created.ex
</span></span><span class="line"><span class="cl">└── lib/strategy_1/before/core_event.ex (compile)
</span></span></code></pre></td></tr></table>
</div>
</div><p>This strategy consists in breaking <code>Core.Event</code> into two parts: <code>Core.Event.Definition</code> with the macros and <code>Core.Event</code> with shared functions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="c1"># lib/strategy_1/after/core_event.ex</span>
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">S1.After.Core.Event</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">emit</span><span class="p">(%{</span><span class="ss">id</span><span class="p">:</span> <span class="n">id</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="n">_data</span><span class="p">}),</span>
</span></span><span class="line"><span class="cl">    <span class="ss">do</span><span class="p">:</span> <span class="nc">S1.After.Services.Log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Emitting event_id=</span><span class="si">#{</span><span class="n">id</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># lib/strategy_1/after/core_event_definition.ex</span>
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">S1.After.Core.Event.Definition</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="kd">defmacro</span> <span class="n">__using__</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="k">quote</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">      <span class="kn">alias</span> <span class="nc">Core.Event</span>
</span></span><span class="line"><span class="cl">      <span class="na">@before_compile</span> <span class="k">unquote</span><span class="p">(</span><span class="n">__MODULE__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">defmacro</span> <span class="n">__before_compile__</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="k">quote</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">      <span class="na">@name</span> <span class="o">||</span> <span class="k">raise</span> <span class="s2">&#34;You must specify the event name via @name&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">def</span> <span class="n">get_name</span><span class="p">,</span> <span class="ss">do</span><span class="p">:</span> <span class="na">@name</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>One thing to keep in mind here is that your <code>Definition</code> module should <em>not</em> have compile-time dependencies to other parts of your application, otherwise you are back to square one.</p>
<p>If you can&rsquo;t get around calling another module within your codebase, try to follow the same pattern: make sure to extract the necessary functions into a dedicated module. The goal is to <em>isolate</em> the functions needed by the macro into their own modules.</p>
<p>By applying this strategy, we are now free of transitive dependencies:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&gt; mix xref graph --label compile-connected | grep after
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">(empty output, meaning there are no transitive dependencies)
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can find the <a class="link" href="https://github.com/renatomassaro/elixir_recompilation_sandbox/tree/main/lib/strategy_1"  target="_blank" rel="noopener"
    >full example in Github</a>.</p>
<h4 id="strategy-2-reference-the-module-during-runtime-absinthe-example">Strategy 2: Reference the module during runtime (Absinthe example)
</h4><p>This strategy (<em>ahem</em> hack) consists in referencing the module during runtime execution, in order to break the chain between <code>queries.ex</code> and <code>resolver.ex</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="c1"># lib/strategy_2/before/queries.ex</span>
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">S2</span><span class="o">.</span><span class="n">before</span><span class="o">.</span><span class="n">queries</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="kn">use</span> <span class="nc">Absinthe.Schema.Notation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">object</span> <span class="ss">:queries</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">field</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:user</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">arg</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1"># We are calling the resolver directly, as any sane person would</span>
</span></span><span class="line"><span class="cl">      <span class="n">resolve</span><span class="p">(</span><span class="o">&amp;</span><span class="nc">S2.Before.Resolver</span><span class="o">.</span><span class="n">query_user</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here&rsquo;s the alternative:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="c1"># lib/strategy_2/after/queries.ex</span>
</span></span><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">S2.After.Queries</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="kn">use</span> <span class="nc">Absinthe.Schema.Notation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">object</span> <span class="ss">:queries</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">field</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:user</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">arg</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">resolve</span><span class="p">(</span><span class="k">fn</span> <span class="n">parent</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">resolution</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Here, we remove the compile-time reference by building</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># the resolver module dynamically</span>
</span></span><span class="line"><span class="cl">        <span class="n">resolver</span><span class="p">()</span><span class="o">.</span><span class="n">query_user</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Either option below works</span>
</span></span><span class="line"><span class="cl">  <span class="kd">defp</span> <span class="n">resolver</span><span class="p">,</span> <span class="ss">do</span><span class="p">:</span> <span class="ss">:&#34;Elixir.S2.Before.Resolver&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># defp resolver, do: Module.concat(S2.Before, Resolver)</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>But Renato, is it safe? Can&rsquo;t this cause some module being stale due to it not recompiling? This is a good question. And I don&rsquo;t have a good answer, except that I&rsquo;ve been using this <del>hack</del> strategy for <em>at least</em> 8 years and don&rsquo;t remember a single instance where it caused inconsistencies.</p>
<p>The downsides of this approach are:</p>
<ol>
<li>Worse code readability, since you are doing something unexpected.</li>
<li>Worse performance, since you are requiring additional function calls.</li>
</ol>
<p>Are the downsides worth the advantage of not having a compilation chain? Almost always, yes! The degraded readability can be abstracted away (as can be seen in the example). The performance overhead is negligible in most cases (a single SQL query will be at least 10,000x slower).</p>
<blockquote>
<p>This strategy is particularly useful for Absinthe: when you break the chain between your queries/mutations and resolvers, you are effectively shielding yourself from transitive dependencies that could potentially impact your entire codebase!</p>
</blockquote>
<p>You can find the <a class="link" href="https://github.com/renatomassaro/elixir_recompilation_sandbox/tree/main/lib/strategy_2"  target="_blank" rel="noopener"
    >full example in Github</a>.</p>
<h4 id="strategy-3-keep-macros-simple">Strategy 3: Keep macros simple
</h4><p>My third strategy is that, whenever possible, keep your macros simple. In other words, make sure they only reference built-in modules and/or 3rd-party libraries.</p>
<blockquote>
<p>If your macro absolutely needs to call some of your own code, then try to <em>isolate</em> that particular code into a single, dedicated module with no external dependencies (this is <a class="link" href="#strategy-1-move-macros-to-dedicated-modules-with-no-additional-dependencies" >Strategy 1</a>, actually).</p>
</blockquote>
<h4 id="strategy-4-dont-use-macros">Strategy 4: Don&rsquo;t use macros
</h4><p>Macros are tempting, I know. Can you <em>not</em> use them at all? If that&rsquo;s a valid option, I recommend you take it.</p>
<p>Macros have the downsides of making code harder to read, harder to test, harder to document, less intuitive and less idiomatic. On the other hand, they have the positives of reducing boilerplate and ensuring consistency and conventions across a codebase.</p>
<p>If you actually <em>need</em> them, make sure you keep them simple (<a class="link" href="#strategy-3-keep-macros-simple" >Strategy 3</a>).</p>
<h2 id="step-4-preventing-it-from-ever-happening-again"><strong>Step 4: Preventing it from ever happening again</strong>
</h2><p>After a lot of work, you managed to get rid of compilation chains! Congratulations! Your co-workers will be very grateful for your refactor.</p>
<h3 id="detecting-transitive-dependencies-in-your-ci-pipeline">Detecting transitive dependencies in your CI pipeline
</h3><p>First, you need to know how many chains you currently have:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mix xref graph --label compile-connected | grep &#34;(compile)&#34; | wc -l
</span></span></code></pre></td></tr></table>
</div>
</div><p>Above command will tell you the number of <code>compile-connected</code> (transitive) dependencies you have.</p>
<p>Then, you can apply the following verification in your pipeline:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">- name: Check for transitive compilation dependencies
</span></span><span class="line"><span class="cl">  run: mix xref graph --label compile-connected --fail-above NUMBER
</span></span></code></pre></td></tr></table>
</div>
</div><p>Replace <code>NUMBER</code> with your current (or target) number of transitive dependencies in your codebase. Your goal should be zero.</p>
<p>Following this method, you will prevent:</p>
<ul>
<li>new chains from showing up.</li>
<li>existing chains from growing up.</li>
</ul>
<blockquote>
<p>Wait! You do have a CI pipeline, right? If you don&rsquo;t have one but you are using Github, just add <a class="link" href="https://github.com/renatomassaro/elixir_recompilation_sandbox/blob/main/.github/workflows/ci.yaml"  target="_blank" rel="noopener"
    >this basic workflow template</a>. It compiles, tests, checks formatting and transitive dependencies. That&rsquo;s a good starting point. Github Actions is free, including private repositories.</p>
</blockquote>
<h2 id="worth-mentioning">Worth mentioning
</h2><h3 id="pattern-matching-on-structs-no-longer-creates-compile-time-dependencies">Pattern-matching on structs no longer creates compile-time dependencies
</h3><p>If you&rsquo;ve been working with Elixir for several years, you might remember this used to be a problem in the past:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">Services.User</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="kn">alias</span> <span class="nc">Schemas.User</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">query</span><span class="p">(%</span><span class="nc">User</span><span class="p">{</span><span class="ss">id</span><span class="p">:</span> <span class="n">id</span><span class="p">})</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Above code would create a compile-time dependency between <code>Services.User</code> and <code>Schemas.User</code>. Since Elixir 1.11 (~2020) this is <a class="link" href="https://hexdocs.pm/elixir/1.11.0/changelog.html#compilation-time-improvements"  target="_blank" rel="noopener"
    >no longer the case</a>. Now, this kind of pattern-match creates an &ldquo;export&rdquo; dependency, which will only trigger a recompilation if the <em>struct</em> of <code>Schemas.User</code> changes.</p>
<blockquote>
<p><strong>Takeaway</strong>: don&rsquo;t be afraid of aliasing and pattern-matching against a struct. It makes your code better, safer, easier to read and won&rsquo;t cause unnecessary compile-time dependencies.</p>
</blockquote>
<h3 id="dont-blindly-rely-on-mix-xref-for-boundaries">Don&rsquo;t (blindly) rely on <code>mix xref</code> for boundaries
</h3><p>As you saw in <a class="link" href="#strategy-2-reference-the-module-during-runtime-absinthe-example" >Strategy 2</a>, a module can reference another dynamically. When that happens <code>mix xref</code> is <em>not</em> able to tell you that <code>A</code> may be calling <code>B</code>.</p>
<blockquote>
<p><strong>Takeaway</strong>: don&rsquo;t blindly trust the <code>mix xref</code> output, especially if you are trying to enforce security/boundaries across modules.</p>
</blockquote>
<h3 id="visualizing-your-dependencies-with-depviz-and-graphviz">Visualizing your dependencies with <code>DepViz</code> and <code>Graphviz</code>
</h3><p>There&rsquo;s this amazing tool that you should use right now: <a class="link" href="https://github.com/axelson/dep_viz"  target="_blank" rel="noopener"
    >DepViz</a>.</p>
<ol>
<li>Simply go to <a class="link" href="https://depviz.jasonaxelson.com/"  target="_blank" rel="noopener"
    >https://depviz.jasonaxelson.com/</a>.</li>
<li>Generate your <code>.dot</code> file with <code>mix xref graph --format dot</code>.</li>
<li>Upload and visualize your clean, well-organized module structure.</li>
</ol>
<p>Alternatively, you can simply use <a class="link" href="https://graphviz.org"  target="_blank" rel="noopener"
    >Graphviz</a>:</p>
<ol>
<li>Generate your <code>.dot</code> file with <code>mix xref graph --format dot</code>.</li>
<li>Generate a <code>.svg</code> of your graph with <code>dot -Tsvg xref_graph.dot -o xref_graph.svg</code>.</li>
<li>Open it in your browser (or whatever) and visualize your module hierarchy.</li>
</ol>
<h2 id="conclusion">Conclusion
</h2><p>Whether you are a CTO, a tech lead or an individual contributor in a team, please, for your own sake, pay attention to your feedback loop.</p>
<p>When starting a new project, an experienced engineer will keep a close eye on this, for they know how important it is in the long term to have a <em>fast</em> loop. However, less experienced engineers, or experienced engineers who don&rsquo;t have a lot of experience with Elixir might not realize they are hurting the feedback loop until it gets too late.</p>
<p>Optimize the feedback loop your developers (or you) go through on a daily basis. I insist: when it comes to productivity, this is the first metric you should care about.</p>
<p>This blog post should contain everything you need to identify and permanently fix (re)compilation issues with your codebase. However, if you have questions or comments, feel free to <a class="link" href="mailto:r@ena.to" >reach out to me via email</a>.</p>
<hr>
<p><a class="link" href="https://news.ycombinator.com/item?id=42017312"  target="_blank" rel="noopener"
    >Discuss on Hacker News</a>.</p>
<hr>
<h2 id="notes">Notes
</h2><p>[0] - If you disagree with this assertion, <em>please</em> shoot me an email. I&rsquo;d love to hear what <em>you</em> consider to be more underestimated than <code>mix xref</code>. <a class="link" href="#a-primer-on-mix-xref" >^</a></p>
<p>[1] - This originally read <code>mix xref --graph</code>; however, the correct command is <code>mix xref graph</code>. Thanks to Sam Weaver (and team) for pointing out this issue! <a class="link" href="#scenario-1-runtime-dependencies" >^</a></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/elixir/">Elixir</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/blog/common-pitfalls-with-repo.transaction-in-elixir/">
        
        
            <div class="article-image">
                <img src="/blog/common-pitfalls-with-repo.transaction-in-elixir/cover.932bd7c8e19a2bab5aae64d7556a82cf_hu449266589100168429.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Common pitfalls with Repo.transaction in Elixir"
                        
                        data-hash="md5-kyvXyOGaK6tarmTXVWqCzw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Common pitfalls with Repo.transaction in Elixir</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2025 Bruno de Barros Ricardo
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.4a1d2692ff5cec068ceaa9d7bcc8a4d28aadfd28b604c06c87dcb493ea180e83.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
